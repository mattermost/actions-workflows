name: Plugin PR Distribution Build

on:
  workflow_call:
    inputs:
      go-version-file:
        description: "Path to the file that declares the Go version"
        type: string
        required: false
        default: go.mod
      dist-target:
        description: "Make target that produces the CI distribution artifact"
        type: string
        required: false
        default: dist-ci
      verify-target:
        description: "Make target that validates multi-platform builds"
        type: string
        required: false
        default: dist
      artifact-pattern:
        description: "Glob pattern matching distribution artifacts"
        type: string
        required: false
        default: dist/*.tar.gz
      s3-prefix:
        description: "Optional S3 prefix (folder) for uploaded artifacts"
        type: string
        required: false

permissions:
  contents: read
  id-token: write

jobs:
  dist:
    runs-on: ubuntu-22.04
    steps:
      - name: ci/checkout-repo
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0

      - name: ci/setup-go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version-file: ${{ inputs.go-version-file }}
          cache: false

      - name: ci/get-short-sha
        id: short-sha
        env:
          PR_SHA: "${{ github.event.pull_request.head.sha }}"
        run: |
          sha_ref="${PR_SHA}"
          if [ -z "$sha_ref" ]; then
            sha_ref="${{ github.sha }}"
          fi
          echo "sha=${sha_ref:0:7}" >> "$GITHUB_OUTPUT"

      - name: ci/build-for-upload
        env:
          DIST_TARGET: ${{ inputs.dist-target }}
        run: make "$DIST_TARGET"

      - name: Resolve artifact destination
        id: destination
        env:
          SHARED_BUCKET: ${{ vars.PLUGIN_DIST_S3_BUCKET }}
          INPUT_PREFIX: ${{ inputs.s3-prefix }}
          SHARED_PREFIX: ${{ vars.PLUGIN_DIST_S3_PREFIX }}
        run: |
          bucket="$SHARED_BUCKET"
          if [ -z "$bucket" ]; then
            echo "Shared S3 bucket is not configured. Define PLUGIN_DIST_S3_BUCKET as an organization or repository variable." >&2
            exit 1
          fi
          echo "bucket=$bucket" >> "$GITHUB_OUTPUT"

          prefix="$INPUT_PREFIX"
          if [ -z "$prefix" ]; then
            if [ -n "$SHARED_PREFIX" ]; then
              prefix="$SHARED_PREFIX"
            else
              plugin="${GITHUB_REPOSITORY#*/}"
              prefix="mattermost-plugins/${plugin}"
            fi
          fi
          echo "prefix=$prefix" >> "$GITHUB_OUTPUT"

      - name: ci/ensure-build-on-all-platforms
        env:
          VERIFY_TARGET: ${{ inputs.verify-target }}
        run: make "$VERIFY_TARGET"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@8df5847569e6427dd6c4fb1cf565c83acfa8afa7 # v6.0.0
        with:
          aws-access-key-id: ${{ secrets.PLUGIN_DELIVERY_AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.PLUGIN_DELIVERY_AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Upload dist to S3
        env:
          ARTIFACT_PATTERN: ${{ inputs.artifact-pattern }}
          S3_BUCKET: ${{ steps.destination.outputs.bucket }}
          S3_PREFIX: ${{ steps.destination.outputs.prefix }}
          SHORT_SHA: ${{ steps.short-sha.outputs.sha }}
        run: |
          set -euo pipefail
          shopt -s nullglob
          plugin="${GITHUB_REPOSITORY#*/}"
          for artifact in $ARTIFACT_PATTERN; do
            if [ ! -f "$artifact" ]; then
              continue
            fi
            base=$(basename "$artifact")
            if [[ "$base" != *.tar.gz ]]; then
              echo "Artifact '$base' does not match required '*.tar.gz' naming." >&2
              exit 1
            fi
            target="${plugin}-${SHORT_SHA}.tar.gz"
            aws s3 cp "$artifact" "s3://${S3_BUCKET}/${S3_PREFIX}/${target}" --acl private
          done


